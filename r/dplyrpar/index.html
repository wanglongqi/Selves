<!doctype html>
<html class="no-js" lang="zh_CN">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>How to parallelize do computation in dplyr</title>

    <link rel="stylesheet" type="text/css" href="https://longqi.ga/assets/css/styles_feeling_responsive.css">

  

	<script src="https://longqi.ga/assets/js/modernizr.min.js"></script>

	<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
	<script>
		WebFont.load({
			google: {
				families: [ 'Lato:400,700,400italic:latin', 'Volkhov::latin' ]
			}
		});
	</script>

	<noscript>
		<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic%7CVolkhov' rel='stylesheet' type='text/css'>
	</noscript>


	<!-- Search Engine Optimization -->
	<meta name="description" content="dplyr is definitely a great tool for data analysis. However, it does not come with multi-core or multi-processor support. And here is we discuss about how to parallelize dplyr functions without too much efforts in rewriting the code to a parallel version.">
	<meta name="google-site-verification" content="">
	<meta name="msvalidate.01" content="" >
	
	<link rel="author" href="">
	
	
	<link rel="canonical" href="https://longqi.ga/r/dplyrpar/">


	<!-- Facebook Open Graph -->
	<meta property="og:title" content="How to parallelize do computation in dplyr">
	<meta property="og:description" content="dplyr is definitely a great tool for data analysis. However, it does not come with multi-core or multi-processor support. And here is we discuss about how to parallelize dplyr functions without too much efforts in rewriting the code to a parallel version.">
	<meta property="og:url" content="https://longqi.ga/r/dplyrpar/">
	<meta property="og:locale" content="zh_CN">
	<meta property="og:type" content="website">
	<meta property="og:site_name" content="Why & How">
	
	


	

	<link type="text/plain" rel="author" href="https://longqi.ga/humans.txt">

	

	

	<link rel="icon" sizes="32x32" href="https://longqi.ga/assets/img/favicon-32x32.png">

	<link rel="icon" sizes="192x192" href="https://longqi.ga/assets/img/touch-icon-192x192.png">

	<link rel="apple-touch-icon-precomposed" sizes="180x180" href="https://longqi.ga/assets/img/apple-touch-icon-180x180-precomposed.png">

	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://longqi.ga/assets/img/apple-touch-icon-152x152-precomposed.png">

	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://longqi.ga/assets/img/apple-touch-icon-144x144-precomposed.png">

	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://longqi.ga/assets/img/apple-touch-icon-120x120-precomposed.png">

	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://longqi.ga/assets/img/apple-touch-icon-114x114-precomposed.png">

	
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://longqi.ga/assets/img/apple-touch-icon-76x76-precomposed.png">

	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://longqi.ga/assets/img/apple-touch-icon-72x72-precomposed.png">

	<link rel="apple-touch-icon-precomposed" href="https://longqi.ga/assets/img/apple-touch-icon-precomposed.png">	

	<meta name="msapplication-TileImage" content="https://longqi.ga/assets/img/msapplication_tileimage.png">

	<meta name="msapplication-TileColor" content="#fabb00">


	

</head>
<body id="top-of-page" class="post-toc">
	
	<div id="navigation" class="sticky">
  <nav class="top-bar" role="navigation" data-topbar>
    <ul class="title-area">
      <li class="name">
      <h1 class="show-for-small-only"><a href="https://longqi.ga" class="icon-tree"> Why & How</a></h1>
    </li>
       <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone -->
      <li class="toggle-topbar menu-icon"><a href="#"><span>导航</span></a></li>
    </ul>
    <section class="top-bar-section">

      <ul class="right">
        

              

          
          
        

              

          
          
        

              

          
          
        

              

          
          
            
            
              <li class="divider"></li>
              <li><a  href="https://longqi.ga/search/">搜索</a></li>

            
            
          
        

              

          
          
            
            
              <li class="divider"></li>
              <li><a  href="https://longqi.ga/contact/">与我联系</a></li>

            
            
          
        
        
      </ul>

      <ul class="left">
        

              

          
          

            
            
              <li><a  href="https://longqi.ga/">主页</a></li>
              <li class="divider"></li>

            
            
          
        

              

          
          

            
            

              <li class="has-dropdown">
                <a  href="https://longqi.ga/projects/">个人项目</a>

                  <ul class="dropdown">
                    

                      

                      <li><a  href="http://writetex.tk" target="_blank">WriteTeX</a></li>
                    
                  </ul>

              </li>
              <li class="divider"></li>
            
          
        

              

          
          

            
            

              <li class="has-dropdown">
                <a  href="https://longqi.ga/blog/">博客</a>

                  <ul class="dropdown">
                    

                      

                      <li><a  href="https://longqi.ga/blog/archive/">文章目录</a></li>
                    
                  </ul>

              </li>
              <li class="divider"></li>
            
          
        

              

          
          
        

              

          
          
        
        
      </ul>
    </section>
  </nav>
</div><!-- /#navigation -->

	

	

<div id="masthead">
	<div class="row">
		<div class="small-12 columns">
			<a id="logo" href="https://longqi.ga/" title="Why & How – Why &amp; How 崴&amp;灏">
				<img src="https://longqi.ga/assets/img/logo.png" alt="Why & How – Why &amp; How 崴&amp;灏">
			</a>
		</div><!-- /.small-12.columns -->
	</div><!-- /.row -->
</div><!-- /#masthead -->










	


<div class="row t30">
	<div class="medium-12 columns">
		<article itemscope itemtype="http://schema.org/Article">
			<header>
				

				<div itemprop="name">
					
					<h1>How to parallelize <em>do</em> computation in <em>dplyr</em></h1>
				</div>
			</header>


			
			<p class="teaser" itemprop="description">
				<code>dplyr</code> is definitely a great tool for data analysis. However, it does not come with multi-core or multi-processor support. And here is we discuss about how to parallelize <code>dplyr</code> functions without too much efforts in rewriting the code to a parallel version.
			</p>
			

			<div itemprop="articleSection">
			<div class="row">
<div class="medium-4 medium-push-8 columns">
    <div class="panel radius">
      <p id="toc"><strong>Table of Contents</strong></p>
<ul id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a>    <ul>
      <li><a href="#preprocessing" id="markdown-toc-preprocessing">Preprocessing</a></li>
      <li><a href="#exploratory" id="markdown-toc-exploratory">Exploratory</a></li>
    </ul>
  </li>
  <li><a href="#a-workable-solution" id="markdown-toc-a-workable-solution">A workable solution</a></li>
  <li><a href="#parallelize-it" id="markdown-toc-parallelize-it">Parallelize it</a></li>
</ul>

    </div>
  </div><!-- /.medium-4.columns -->



<div class="medium-8 medium-pull-4 columns">

    <div class="alert-box warning "><p>This is not an entry level article. If you cannot understand the content, most likely it is because of my poor English. If not, you should probably learn more about <em>dplyr</em>, <em>forecast</em>(time series analysis library. This article uses this library heavily), <em>ggplot2</em>(plotting library) and basics in parallel computing such as threads and processes.</p>
</div>

    <h2 id="introduction">Introduction</h2>

    <p>Recently, I took apart in the <a href="https://tianchi.shuju.aliyun.com/competition/introduction.htm?raceId=231591">IJCAI-17 Customer Flow Forecasts</a>. It is an interesting competition in some extent. The <a href="https://tianchi.shuju.aliyun.com/competition/information.htm?raceId=231591">datasets</a> provided include:</p>

    <ol>
      <li>shop_info: shop information data</li>
      <li>user_pay: users pay behavior</li>
      <li>user_view: users view behavior</li>
      <li>prediction：test set and submission format</li>
    </ol>

    <p>Because the nature of this problem is to predict time series, methods specifically designed for this task should be tested. The well-known ones include:</p>

    <ol>
      <li>ARIMA series models</li>
      <li>ETS series models</li>
      <li>Regression models</li>
    </ol>

    <p>And it is not hard to find out that customer flow is a seasonal time series. Therefore, time series decomposition such as X12 and STL may be useful tools in analysis.</p>

    <h3 id="preprocessing">Preprocessing</h3>

    <p>The datasets include plenty of information such as the <code class="highlighter-rouge">user_id</code> make a payment to <code class="highlighter-rouge">shop_id</code> at <code class="highlighter-rouge">time</code>. Because the goal is to predict the flow of each shop and it is hard to build a <code class="highlighter-rouge">user_id</code> profile based model with only this amount of data provided, a <code class="highlighter-rouge">shop_id</code> profile based solution appears to be a better choice, i.e., we will build a model for each shop, and do the prediction. Therefore, for the preprocessing, the <code class="highlighter-rouge">user_id</code> should be aggregated. This is a pretty entry level task for <code class="highlighter-rouge">dpylr</code>(R) or <code class="highlighter-rouge">pandas</code>(Python) user. Therefore, I do not share code for this part, the results are organized as following dataset:</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">psych</span><span class="p">)</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">tc2017</span><span class="p">)</span></code></pre></figure>

    <div class="highlighter-rouge"><pre class="highlight"><code>##     shop_id       time_stamp             date_week         nb_pay      
##  Min.   :   1   Min.   :2015-06-26   Monday   :86544   Min.   :   1.0  
##  1st Qu.: 504   1st Qu.:2016-02-03   Tuesday  :84851   1st Qu.:  51.0  
##  Median :1019   Median :2016-05-22   Wednesday:85283   Median :  82.0  
##  Mean   :1008   Mean   :2016-05-04   Thursday :85643   Mean   : 116.3  
##  3rd Qu.:1512   3rd Qu.:2016-08-15   Friday   :86041   3rd Qu.: 135.0  
##  Max.   :2000   Max.   :2016-10-31   Saturday :84902   Max.   :4704.0  
##                                      Sunday   :86011
</code></pre>
    </div>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">describe</span><span class="p">(</span><span class="n">tc2017</span><span class="p">)</span></code></pre></figure>

    <div class="highlighter-rouge"><pre class="highlight"><code>##             vars      n    mean     sd median trimmed    mad min  max
## shop_id        1 599275 1007.58 577.88   1019 1008.69 747.23   1 2000
## time_stamp*    2 599275     NaN     NA     NA     NaN     NA Inf -Inf
## date_week*     3 599275    4.00   2.00      4    4.00   2.97   1    7
## nb_pay         4 599275  116.26 132.04     82   93.64  54.86   1 4704
##             range  skew kurtosis   se
## shop_id      1999 -0.02    -1.22 0.75
## time_stamp*  -Inf    NA       NA   NA
## date_week*      6  0.00    -1.25 0.00
## nb_pay       4703  7.06   105.67 0.17
</code></pre>
    </div>

    <h3 id="exploratory">Exploratory</h3>

    <p>First, let us make some figures using off course <code class="highlighter-rouge">ggplot2</code>. Plots for first five shops:</p>

    <p><img src="/images/dplyrpar/unnamed-chunk-1-1.png" alt="" /><img src="/images/dplyrpar/unnamed-chunk-1-2.png" alt="" /></p>

    <p>Above two figures are quite messy. We can notice that the data have different range, which means that we may have to worry about NAs. Moreover, most of the series do not steady in the given range. For these five curves, the curves are more steady after April 2016. Then, above series are plotted into separated panels as follows:</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">tc2017</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">shop_id</span><span class="o">&lt;</span><span class="m">6</span><span class="p">),</span><span class="n">aes</span><span class="p">(</span><span class="n">time_stamp</span><span class="p">,</span><span class="n">nb_pay</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">shop_id</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"free"</span><span class="p">)</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></code></pre></figure>

    <p><img src="/images/dplyrpar/unnamed-chunk-2-1.png" alt="" /></p>

    <p>Some series have strong seasonal feature, such as curve for <code class="highlighter-rouge">shop_id==4</code>. We may need to consider the seasonal effect. A quick <code class="highlighter-rouge">acf</code> drawing is shown as below:</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">acf</span><span class="p">((</span><span class="n">tc2017</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">shop_id</span><span class="o">==</span><span class="m">4</span><span class="p">))</span><span class="o">$</span><span class="n">nb_pay</span><span class="p">)</span></code></pre></figure>

    <p><img src="/images/dplyrpar/unnamed-chunk-3-1.png" alt="" /></p>

    <p>It can be observed that the periodic pattern is quite clear, the period is 7 and it is the length of one week. Therefore, we plot the data against the weekday:</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">tc2017</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">shop_id</span><span class="o">==</span><span class="m">4</span><span class="p">),</span><span class="w">
            </span><span class="n">aes</span><span class="p">(</span><span class="n">time_stamp</span><span class="p">,</span><span class="n">nb_pay</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">facet_grid</span><span class="p">(</span><span class="n">date_week</span><span class="o">~</span><span class="n">.</span><span class="p">,</span><span class="n">scales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"fixed"</span><span class="p">)</span><span class="o">+</span><span class="w">
  </span><span class="n">theme_bw</span><span class="p">()</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></code></pre></figure>

    <p><img src="/images/dplyrpar/unnamed-chunk-4-1.png" alt="" /></p>

    <p>It is shown in above figure, the number of customs is much steady when we investigate the flow on the same weekday. This pattern also appears in the data of other shops.</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">tc2017</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">shop_id</span><span class="o">&lt;</span><span class="m">6</span><span class="p">),</span><span class="w">
            </span><span class="n">aes</span><span class="p">(</span><span class="n">time_stamp</span><span class="p">,</span><span class="n">nb_pay</span><span class="p">,</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_week</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">facet_grid</span><span class="p">(</span><span class="n">date_week</span><span class="o">~</span><span class="n">shop_id</span><span class="p">,</span><span class="n">scales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"free"</span><span class="p">)</span><span class="o">+</span><span class="w">
  </span><span class="n">scale_color_brewer</span><span class="p">(</span><span class="n">palette</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Set1"</span><span class="p">)</span><span class="o">+</span><span class="w">
  </span><span class="n">theme_bw</span><span class="p">()</span><span class="o">+</span><span class="w"> </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"none"</span><span class="p">)</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></code></pre></figure>

    <p><img src="/images/dplyrpar/unnamed-chunk-5-1.png" alt="" /></p>

    <p>Generally, the flows have quite different patterns between weekdays and weekends. However, the longtime trend also plays important role in the flow.</p>

    <p>Let’s make some predictions here:</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">forecast</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">xts</span><span class="p">)</span><span class="w">
</span><span class="n">to.ts</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">ts</span><span class="p">(</span><span class="n">x</span><span class="o">$</span><span class="n">nb_pay</span><span class="p">,</span><span class="n">frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">to.ts</span><span class="p">(</span><span class="n">tc2017</span><span class="o">%&gt;%</span><span class="n">filter</span><span class="p">(</span><span class="n">shop_id</span><span class="o">==</span><span class="m">1</span><span class="p">))</span><span class="w">

</span><span class="n">autoplot</span><span class="p">(</span><span class="n">forecast</span><span class="p">(</span><span class="n">stlm</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme_bw</span><span class="p">()</span></code></pre></figure>

    <p><img src="/images/dplyrpar/unnamed-chunk-6-1.png" alt="" /></p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">autoplot</span><span class="p">(</span><span class="n">forecast</span><span class="p">(</span><span class="n">ets</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme_bw</span><span class="p">()</span></code></pre></figure>

    <p><img src="/images/dplyrpar/unnamed-chunk-6-2.png" alt="" /></p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">autoplot</span><span class="p">(</span><span class="n">forecast</span><span class="p">(</span><span class="n">tbats</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme_bw</span><span class="p">()</span></code></pre></figure>

    <p><img src="/images/dplyrpar/unnamed-chunk-6-3.png" alt="" /></p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">autoplot</span><span class="p">(</span><span class="n">forecast</span><span class="p">(</span><span class="n">auto.arima</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="kc">NA</span><span class="p">,</span><span class="m">1</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme_bw</span><span class="p">()</span></code></pre></figure>

    <p><img src="/images/dplyrpar/unnamed-chunk-6-4.png" alt="" /> How about <code class="highlighter-rouge">shope_id==4</code>:</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">to.ts</span><span class="p">(</span><span class="n">tc2017</span><span class="o">%&gt;%</span><span class="n">filter</span><span class="p">(</span><span class="n">shop_id</span><span class="o">==</span><span class="m">4</span><span class="p">))</span><span class="w">

</span><span class="n">autoplot</span><span class="p">(</span><span class="n">forecast</span><span class="p">(</span><span class="n">stlm</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme_bw</span><span class="p">()</span></code></pre></figure>

    <p><img src="/images/dplyrpar/unnamed-chunk-7-1.png" alt="" /></p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">autoplot</span><span class="p">(</span><span class="n">forecast</span><span class="p">(</span><span class="n">ets</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme_bw</span><span class="p">()</span></code></pre></figure>

    <p><img src="/images/dplyrpar/unnamed-chunk-7-2.png" alt="" /></p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">autoplot</span><span class="p">(</span><span class="n">forecast</span><span class="p">(</span><span class="n">tbats</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme_bw</span><span class="p">()</span></code></pre></figure>

    <p><img src="/images/dplyrpar/unnamed-chunk-7-3.png" alt="" /></p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">autoplot</span><span class="p">(</span><span class="n">forecast</span><span class="p">(</span><span class="n">auto.arima</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="kc">NA</span><span class="p">,</span><span class="m">1</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme_bw</span><span class="p">()</span></code></pre></figure>

    <p><img src="/images/dplyrpar/unnamed-chunk-7-4.png" alt="" /></p>

    <p>OK, this is the end of the analysis, otherwise the article becomes a tutorial on analyzing the competition data. Based on the results above, the performances of the well-known methods are pretty decent in my opinion. Next is how to calculate them in 2000 shops.</p>

    <h2 id="a-workable-solution">A workable solution</h2>

    <p><code class="highlighter-rouge">ets</code> is a fast algorithm, and its performance is quite good. Therefore, let’s assume we want to apply <code class="highlighter-rouge">ets</code> to the whole dataset. The easiest way is to use some functions from <code class="highlighter-rouge">dplyr</code>. <code class="highlighter-rouge">summarise</code> is a good candidate, but it only able to capture functions with only one return value, such as <code class="highlighter-rouge">mean</code> and <code class="highlighter-rouge">median</code>:</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">tc2017</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">group_by</span><span class="p">(</span><span class="n">shop_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">nb_pay</span><span class="p">),</span><span class="n">median</span><span class="p">(</span><span class="n">nb_pay</span><span class="p">))</span><span class="w"> </span></code></pre></figure>

    <div class="highlighter-rouge"><pre class="highlight"><code>## # A tibble: 2,000 × 3
##    shop_id `mean(nb_pay)` `median(nb_pay)`
##      &lt;int&gt;          &lt;dbl&gt;            &lt;dbl&gt;
## 1        1      239.50646              228
## 2        2      118.87538               92
## 3        3       76.97794               74
## 4        4      129.58095              116
## 5        5      155.71782              158
## 6        6       62.11765               60
## 7        7      144.79917              139
## 8        8       81.63043               76
## 9        9      182.61035              171
## 10      10       45.39024               43
## # ... with 1,990 more rows
</code></pre>
    </div>

    <p>So, we need a general version of <code class="highlighter-rouge">summarise</code>, and what we get is <code class="highlighter-rouge">do</code>:</p>

    <blockquote>
      <p>This is a general purpose complement to the specialised manipulation functions filter, select, mutate, summarise and arrange. You can use do to perform arbitrary computation, returning either a data frame or arbitrary objects which will be stored in a list. This is particularly useful when working with models: you can fit models per group with do and then flexibly extract components with either another do or summarise.</p>
    </blockquote>

    <p>Here is where most people get stuck, because the first example of this function is something like:</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">head3</span></code></pre></figure>

    <div class="highlighter-rouge"><pre class="highlight"><code>## Source: local data frame [6,000 x 4]
## Groups: shop_id [2,000]
## 
##    shop_id time_stamp date_week nb_pay
##      &lt;int&gt;     &lt;date&gt;    &lt;fctr&gt;  &lt;int&gt;
## 1        1 2015-10-10  Saturday    188
## 2        1 2015-10-11    Sunday    272
## 3        1 2015-10-12    Monday    257
## 4        2 2015-11-25 Wednesday     55
## 5        2 2015-11-26  Thursday    175
## 6        2 2015-11-27    Friday    186
## 7        3 2016-06-18  Saturday     71
## 8        3 2016-06-19    Sunday     45
## 9        3 2016-06-20    Monday     62
## 10       4 2016-07-19   Tuesday     74
## # ... with 5,990 more rows
</code></pre>
    </div>

    <p>Above function extracted the first three values appearing for each shop. The data structure what we get is the same as the original one. Pretty good? No, what we need is <code class="highlighter-rouge">You can use do to perform arbitrary computation, returning either a data frame or arbitrary objects which will be stored in a list.</code> And the first example absolutely sent us to a wrong direction. Actually, the later examples did the right thing. The trick is to assign the return value to a variable:</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">head3</span></code></pre></figure>

    <div class="highlighter-rouge"><pre class="highlight"><code>## Source: local data frame [2,000 x 2]
## Groups: &lt;by row&gt;
## 
## # A tibble: 2,000 × 2
##    shop_id     head3
## *    &lt;int&gt;    &lt;list&gt;
## 1        1 &lt;int [3]&gt;
## 2        2 &lt;int [3]&gt;
## 3        3 &lt;int [3]&gt;
## 4        4 &lt;int [3]&gt;
## 5        5 &lt;int [3]&gt;
## 6        6 &lt;int [3]&gt;
## 7        7 &lt;int [3]&gt;
## 8        8 &lt;int [3]&gt;
## 9        9 &lt;int [3]&gt;
## 10      10 &lt;int [3]&gt;
## # ... with 1,990 more rows
</code></pre>
    </div>

    <p>And the <code class="highlighter-rouge">head3</code> column is what we want:</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">head3</span><span class="o">$</span><span class="n">head3</span><span class="p">[</span><span class="m">1</span><span class="p">]</span></code></pre></figure>

    <div class="highlighter-rouge"><pre class="highlight"><code>## [[1]]
## [1] 188 272 257
</code></pre>
    </div>

    <p>OK, good. The next thing is to write a forecast function and apply it the dataset. <code class="highlighter-rouge">forecast</code> library is what we are looking for.</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">forecast</span><span class="p">)</span><span class="w">
</span><span class="n">forecast.by.ets</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">df</span><span class="p">){</span><span class="w">
  </span><span class="n">forecast</span><span class="p">(</span><span class="n">ets</span><span class="p">(</span><span class="n">to.ts</span><span class="p">(</span><span class="n">df</span><span class="p">)),</span><span class="m">14</span><span class="p">)</span><span class="o">$</span><span class="n">mean</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

    <p>Let’s test this function:</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">forecast.by.ets</span><span class="p">(</span><span class="n">tc2017</span><span class="o">%&gt;%</span><span class="n">filter</span><span class="p">(</span><span class="n">shop_id</span><span class="o">==</span><span class="m">1</span><span class="p">))</span></code></pre></figure>

    <div class="highlighter-rouge"><pre class="highlight"><code>## Time Series:
## Start = c(56, 3) 
## End = c(58, 2) 
## Frequency = 7 
##  [1] 220.4800 229.6598 223.8705 250.1321 243.6516 221.6542 219.3051
##  [8] 220.4803 229.6601 223.8707 250.1323 243.6519 221.6545 219.3053
</code></pre>
    </div>

    <p>OK, it seems working. Then applying it to the whole dataset:</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">out</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tc2017</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">group_by</span><span class="p">(</span><span class="n">shop_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">do</span><span class="p">(</span><span class="n">predict</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">forecast.by.ets</span><span class="p">(</span><span class="n">.</span><span class="p">))</span></code></pre></figure>

    <p>Above function is correct. Why I leave it there is that it is so slow for our goal and here comes what this article about: how to parallelized this computation? But first let me show you above function do works:</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">out</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tc2017</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">shop_id</span><span class="o">&lt;</span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">shop_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">do</span><span class="p">(</span><span class="n">predict</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">forecast.by.ets</span><span class="p">(</span><span class="n">.</span><span class="p">))</span><span class="w">
</span><span class="n">out</span></code></pre></figure>

    <div class="highlighter-rouge"><pre class="highlight"><code>## Source: local data frame [2 x 2]
## Groups: &lt;by row&gt;
## 
## # A tibble: 2 &amp;times; 2
##   shop_id  predict
## *   &lt;int&gt;   &lt;list&gt;
## 1       1 &lt;S3: ts&gt;
## 2       2 &lt;S3: ts&gt;
</code></pre>
    </div>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">out</span><span class="o">$</span><span class="n">predict</span><span class="p">[</span><span class="m">1</span><span class="p">]</span></code></pre></figure>

    <div class="highlighter-rouge"><pre class="highlight"><code>## [[1]]
## Time Series:
## Start = c(56, 3) 
## End = c(58, 2) 
## Frequency = 7 
##  [1] 220.4800 229.6598 223.8705 250.1321 243.6516 221.6542 219.3051
##  [8] 220.4803 229.6601 223.8707 250.1323 243.6519 221.6545 219.3053
</code></pre>
    </div>

    <h2 id="parallelize-it">Parallelize it</h2>

    <p>Finally, all the stuffs that we need are prepared. Now the problem is following code only run in one core, which is a total waste. Come on, these jobs are perfectly separated from each other.</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">out</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tc2017</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">group_by</span><span class="p">(</span><span class="n">shop_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">do</span><span class="p">(</span><span class="n">predict</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">forecast.by.ets</span><span class="p">(</span><span class="n">.</span><span class="p">))</span></code></pre></figure>

    <p>Yes, you can just ignore <code class="highlighter-rouge">dplyr</code> function and write your own parallel version using something like <code class="highlighter-rouge">foreach</code> or <code class="highlighter-rouge">parallel</code>. However, luckily there is a simple solution for this problem by the author of <code class="highlighter-rouge">ggplot2</code>. He provided a very elegant way to solve this problem. The library is named <code class="highlighter-rouge">multidplyr</code>. (NOT multiplyr)</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">multidplyr</span><span class="p">)</span></code></pre></figure>

    <p><code class="highlighter-rouge">multidplyr</code> is a fantastic library. The best thing about <code class="highlighter-rouge">multidplyr</code> is that you need <strong>very little</strong> modification of your original <code class="highlighter-rouge">dplyr</code> version codes, and <code class="highlighter-rouge">multidplyr</code> will take care of almost all the other things. For our case, the codes become:</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">out</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tc2017</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">partition</span><span class="p">(</span><span class="n">shop_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">do</span><span class="p">(</span><span class="n">predict</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">forecast.by.ets</span><span class="p">(</span><span class="n">.</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">collect</span><span class="p">()</span><span class="w"> </span></code></pre></figure>

    <p>What is the difference? The <code class="highlighter-rouge">group_by</code> function is changed to <code class="highlighter-rouge">partition</code>, and we need to collect the data to its original format using <code class="highlighter-rouge">collect</code>. So basically, you need nothing to do, right? Clearly above code can not run correctly. At least, we need some kind of broadcast even we do not need sync in this case. In order solve this you will need some codes like:</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">cluster</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_default_cluster</span><span class="p">()</span><span class="w">
</span><span class="n">cluster_library</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span><span class="w"> </span><span class="s2">"forecast"</span><span class="p">)</span><span class="w">
</span><span class="n">cluster_library</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span><span class="w"> </span><span class="s2">"dplyr"</span><span class="p">)</span><span class="w">

</span><span class="n">cluster_assign_value</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span><span class="s2">"forecast.by.ets"</span><span class="p">,</span><span class="n">forecast.by.ets</span><span class="p">)</span><span class="w">
</span><span class="n">cluster_assign_value</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span><span class="s2">"to.ts"</span><span class="p">,</span><span class="n">to.ts</span><span class="p">)</span></code></pre></figure>

    <p>You may need to change some codes above for your own prediction function. Basically, you will need all the libraries and functions are correctly loaded in all the cluster nodes. Because our jobs are perfectly separated from each other, there is no need for sync data between nodes which is much easier for us and also faster.</p>

    <p>To conclude, parallelize <code class="highlighter-rouge">dplyr</code> <code class="highlighter-rouge">do</code> function is easy by using <code class="highlighter-rouge">multidplyr</code>. Normally you need a <code class="highlighter-rouge">dplyr</code> version working code first. Because we are more familiar with it, and it is much easier to debug the <code class="highlighter-rouge">dplyr</code> version code than the parallelized version. After you have working <code class="highlighter-rouge">dplyr</code> version solution, you can use <code class="highlighter-rouge">multidplyr</code> to partition the problem and distribute them to a cluster. This is a well-designed framework, although it cannot dealing with more serious parallelize problem requiring communication between nodes.</p>

    <p>BTW, <code class="highlighter-rouge">multidplyr</code> is not available in CRAN, the <code class="highlighter-rouge">multiplyr</code> in CRAN is not what we are looking for. You need <code class="highlighter-rouge">devtools</code> to install <code class="highlighter-rouge">multidplyr</code> (if you do not have <code class="highlighter-rouge">devtools</code>, install it with the commented line below.):</p>

    <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># install.packages("devtools")
</span><span class="n">devtools</span><span class="o">::</span><span class="n">install_github</span><span class="p">(</span><span class="s2">"hadley/multidplyr"</span><span class="p">)</span></code></pre></figure>

  </div>
</div>

			</div>

			
						<div id="page-meta" class="t30">
				<p>
					<!-- Look the author details up from the site config. -->
					
					<!-- Output author details if some exist. -->
					

				
				<time class="icon-calendar pr20" datetime="2017-02-25T23:20:29+08:00" itemprop="datePublished"> 2017-02-25</time>
				

				<span class="icon-archive pr20"> R</span>
				<br />
				<span class="pr20"><span class="icon-price-tag pr10"> R</span> <span class="icon-price-tag pr10"> dplyr</span> <span class="icon-price-tag pr10"> Tutorial</span> </span>
			</p>

			
			<div id="post-nav" class="row">
				
				<div class="small-2 columns text-center"><a class="radius button small" href="https://longqi.ga/blog/archive/" title="Blog 目录">目录</a></div><!-- /.small-4.columns -->
				
				<div class="small-5 columns text-right"><a class="button small radius next" href="https://longqi.ga/research/dplyrpar/">路面粗糙度的模拟 &raquo;</a></div><!-- /.small-4.columns -->
				
			</div>
			
			</div><!--  /.page-meta -->

			

			
						
				<h3 id="comments" class="t60">评论</h3>
			    <div id="disqus_thread"></div>
			    <script type="text/javascript">
			        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
			        var disqus_shortname = 'whyhow'; 
			        var disqus_identifier = '/r/dplyrpar/';

			        /* * * DON'T EDIT BELOW THIS LINE * * */
			        (function() {
			            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			        })();
			    </script>
			    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			



			
		</article>
	</div><!-- /.medium-12.columns -->
</div><!-- /.row -->







	
	    <div id="up-to-top" class="row">
      <div class="small-12 columns" style="text-align: right;">
        <a class="iconfont" href="#top-of-page">&#xf108;</a>
      </div><!-- /.small-12.columns -->
    </div><!-- /.row -->


    <footer id="footer-content" class="bg-grau">
      <div id="footer">
        <div class="row">
          <div class="medium-6 large-5 columns">
            <h5 class="shadow-black">关于本站</h5>

            <p class="shadow-black">
              以生之有涯随知之无涯，殆矣，然何为，为何为。
              <a href="https://longqi.ga/info/">更多 ›</a>
            </p>
          </div><!-- /.large-6.columns -->


          <div class="small-6 medium-3 large-3 large-offset-1 columns">
            
              
                <h5 class="shadow-black">Services</h5>
              
            
              
            
              
            
              
            
              
            

              <ul class="no-bullet shadow-black">
              
                
                  <li >
                    <a href="https://longqi.ga"  title=""></a>
                  </li>
              
                
                  <li >
                    <a href="https://longqi.ga/contact/"  title="Contact">Contact</a>
                  </li>
              
                
                  <li >
                    <a href="https://longqi.ga/feed.xml"  title="Subscribe to RSS Feed">RSS</a>
                  </li>
              
                
                  <li >
                    <a href="https://longqi.ga/atom.xml"  title="Subscribe to Atom Feed">Atom</a>
                  </li>
              
                
                  <li >
                    <a href="https://longqi.ga/sitemap.xml"  title="Sitemap for Google Webmaster Tools">sitemap.xml</a>
                  </li>
              
              </ul>
          </div><!-- /.large-4.columns -->


          <div class="small-6 medium-3 large-3 columns">
            
              
                <h5 class="shadow-black">Acknowledgment</h5>
              
            
              
            
              
            
              
            
              
            

            <ul class="no-bullet shadow-black">
            
              
                <li >
                  <a href="https://longqi.ga"  title=""></a>
                </li>
            
              
                <li class="theme" >
                  <a href="http://phlow.de/" target="_blank"  title="Theme by PHLOW">Theme by PHLOW</a>
                </li>
            
              
                <li class="backend" >
                  <a href="http://jekyllrb.com/" target="_blank"  title="Power by Jekyll">Power by Jekyll</a>
                </li>
            
              
                <li class="server" >
                  <a href="http://github.com/" target="_blank"  title="Hosted on Github">Hosted on Github</a>
                </li>
            
              
                <li class="server" >
                  <a href="http://cloudflare.com/" target="_blank"  title="CDN through Cloudflare">CDN through Cloudflare</a>
                </li>
            
            </ul>
          </div><!-- /.large-3.columns -->
        </div><!-- /.row -->

      </div><!-- /#footer -->


      <div id="subfooter">
        <nav class="row">
          <section id="subfooter-left" class="small-12 medium-6 columns credits">
            
          </section>

          <section id="subfooter-right" class="small-12 medium-6 columns">
            <ul class="inline-list social-icons">
            
              <li><a href="http://github.com/wanglongqi" target="_blank" class="icon-github" title="GitHub"></a></li>
            
              <li><a href="http://whyhow.tk" target="_blank" class="icon-globe" title="Whyhow"></a></li>
            
              <li><a href="http://whyhow.tk" target="_blank" class="icon-cog" title="WriteTeX"></a></li>
            
              <li><a href="http://pyconsole.tk" target="_blank" class="icon-code" title="PyConsole"></a></li>
            
              <li><a href="https://github.com/wanglongqi/RoadProfile" target="_blank" class="icon-lab-flask" title="RoadProfile"></a></li>
            
            </ul>
          </section>
        </nav>
      </div><!-- /#subfooter -->
    </footer>

	

	


<script src="https://longqi.ga/assets/js/javascript.min.js"></script>


<script>
    $("#masthead").backstretch("/images/lazyboy.jpg", {fade: 700});
    $("#masthead-with-text").backstretch("/images/lazyboy.jpg", {fade: 700});
</script>





<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6527820-1', 'auto');
  ga('require', 'displayfeatures');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>









</body>
</html>

